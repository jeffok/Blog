---
title: 网卡多队列配置开启RPS特性
date: 2020-06-13 15:19:00
tags: ["脚本", "网络", "Bash", "Shell"]
categories: ["Network"]
render_with_liquid: false
permalink: /posts/2020-06-13-网卡多队列配置开启RPS特性/
---

本文档介绍 网卡多队列配置开启RPS特性 的相关内容。

查看网卡队列支持情况

```json
[root@localhost ~]# ethtool -l eth0
Channel parameters for eth0:
Pre-set maximums:
RX: 0
TX: 0
Other: 0
Combined: 2 # 表示最多支持设置2个队列
Current hardware settings:
RX: 0
TX: 0
Other: 0
Combined: 1 # 表示当前生效的是1个队列

```

修改网卡多队列

```text
ethtool -L eth0 combined 2

```

开启irqbalance服务，让实例自动调整网络中断在多个vCPU核上的分配

```bash
systemctl start irqbalance
systemctl status irqbalance
systemctl enable irqbalance

```

> 说明 开启网卡多队列后，如果网络性能提升仍达不到您的预期，您可以考虑开启RPS（Receive Packet Steering）特性。

开启RPS特性脚本

```ini
# !/bin/bash

cpu_num=$(grep -c processor /proc/cpuinfo)
quotient=$((cpu_num/8))
if [ $quotient -gt 2 ]; then
quotient=2
elif [ $quotient -lt 1 ]; then
quotient=1
fi
for i in $(seq $quotient)
do
cpuset="${cpuset}f"
done
for rps_file in $(ls /sys/class/net/eth*/queues/rx-*/rps_cpus)
do
echo $cpuset > $rps_file
done

```
