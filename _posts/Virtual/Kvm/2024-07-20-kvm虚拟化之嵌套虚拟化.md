---
title: kvm虚拟化之嵌套虚拟化
date: 2024-07-20 13:17:00
tags: ["虚拟化", "内核", "Linux", "KVM", "CentOS"]
categories: ["Virtual", "Kvm"]
render_with_liquid: false
permalink: /posts/2024-07-20-kvm虚拟化之嵌套虚拟化/
---
> http://www.isjian.com/virtualization/kvm-nested-virtualization/

```ini
vim /etc/default/grub

GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="rd.lvm.lv=centos/root rhgb quiet kvm-intel.nested=1"  #加入kvm-intel.nested=1
GRUB_DISABLE_RECOVERY="true"

# kvm-intel.nested=1

grub2-mkconfig -o /boot/grub2/grub.cfg

也可使用下边的方式修改
grubby --info=ALL  查看所有参数
 grubby --remove-args "rhgb quiet" --update-kernel /boot/vmlinuz-3.10.0-229.el7.x86_64   删除记录
 grubby --args "rhgb quiet" --update-kernel /boot/vmlinuz-3.10.0-229.el7.x86_64   增加记录
 grubby --update-kernel=ALL --args="console=ttyS0"  增加记录
 # 确认是否可以执行grub2-mkconfig -o /boot/grub2/grub.cfg

```

## 建立一台支持”vmx”的虚拟机

> 如果你使用libvirt管理虚拟机,需要修改虚拟机xml文件中CPU的定义,下面三种定义都可以

```bash
# 可以使用这种

  <cpu mode='custom' match='exact'>
    <model fallback='allow'>core2duo</model>
    <feature policy='require' name='vmx'/>
  </cpu>

# 这种方式为虚拟机定义需要模拟的CPU类型"core2duo",并且为虚拟机添加"vmx"特性

# 也可以使用这种

  <cpu mode='host-model'>
    <model fallback='allow'/>
  </cpu>

# 或者这样

 <cpu mode='host-passthrough'>
    <topology sockets='2' cores='2' threads='2'/>
  </cpu>

# CPU穿透,在虚拟机中看到的vcpu将会与物理机的CPU同样配置,这种方式缺点在于如果要对虚拟机迁移,迁移的目的服务器硬件配置必须与当前物理机一样

```

## 如果你使用qemu-kvm命令行启动虚拟机,那么可以简单的添加

```bash
enable-kvm -cpu qemu64,+vmx

# 设置虚拟机CPU为qemu64型号,添加vmx支持

```

## 然后启动虚拟机,查看配置

```bash
# 下面虚拟机CPU定义为"host-model"

cat /proc/cpuinfo
processor    : 0
vendor_id    : GenuineIntel
cpu family    : 6
model        : 26
model name    : Intel Core i7 9xx (Nehalem Class Core i7)
...
wp        : yes
flags        : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc unfair_spinlock pni vmx ssse3 cx16 pcid sse4_1 sse4_2 x2apic
...

```
